version: '3.9'
services:

  ### INGRESS ###

  traefik:
    profiles: [all, h9y, main, traefik]
    image: traefik:v3.6.4
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    command:
      - "--entrypoints.web.address=:80"
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--entrypoints.web.http.redirections.entrypoint.permanent=true"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.websecure.http.tls=true"
      - "--providers.file.filename=/dynamic/tls.yaml"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--api.dashboard=true"
      - "--api.insecure=false"
      - "--log.level=INFO"
      - "--accesslog=true"
      - "--metrics.prometheus=false"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./config/traefik/tls.yaml:/dynamic/tls.yaml:ro
      - ./certs/${DOMAIN}/tls.crt:/certs/local.crt:ro
      - ./certs/${DOMAIN}/tls.key:/certs/local.key:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`traefik.${DOMAIN}`)"
      - "traefik.http.routers.traefik.entrypoints=websecure"
      - "traefik.http.routers.traefik.service=api@internal"
      - "traefik.http.routers.traefik.tls=true"
      # Basicâ€‘auth middleware
      # - "traefik.http.middlewares.traefik-auth.basicauth.users=<PASTE_HASH_HERE>"
      # - "traefik.http.routers.traefik.middlewares=dashboard-auth@docker"

  ### DATABASES ###

  mongo:
    profiles: [all, h9y, mongo, main]
    image: mongo:8.0.11-noble
    ports:
      - 27017:27017
    volumes:
      - mongo-volume:/data/db

  redis:
    profiles: [all, h9y, main]
    image: redis:6-alpine
    command: redis-server --appendonly yes
    ports:
      - 6379:6379
    volumes:
      - redis-volume:/data
    stop_grace_period: 30s

  vault:
    profiles: [all, h9y, vault, main, agency]
    image: hashicorp/vault:1.13.3
    command: vault server -config=/vault/config/config.hcl
    cap_add:
      - IPC_LOCK
    ports:
      - 8200:8200
      - 8201:8201
    volumes:
      - vault-volume:/vault/file
      - ./config/vault/config.hcl:/vault/config/config.hcl
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.vault.rule=Host(`vault.${DOMAIN}`)"
      - "traefik.http.routers.vault.entrypoints=websecure"
      - "traefik.http.routers.vault.tls=true"
      - "traefik.http.services.vault.loadbalancer.server.port=8200"

  chroma:
    profiles: [all, h9y, chroma, rag]
    image: chromadb/chroma:1.3.6
    ports:
      - 8121:8121
    environment:
      - CHROMA_PERSIST_DIRECTORY=/chroma/data
      - CHROMA_PORT=8121
    volumes:
      - chroma-volume:/chroma/chroma

  postgres:
    profiles: [all, h9y, postgres, agency, prosody]
    image: postgres:17.4
    restart: always
    shm_size: 128mb
    environment:
      - POSTGRES_DB=postgres_prosody
      - POSTGRES_PASSWORD=postgres_secret_123
      - POSTGRES_USER=postgres_user
    volumes:
      - postgres-volume:/var/lib/postgresql/data

  ollama:
    profiles: [all, h9y, ollama]
    image: ollama/ollama:0.5.7
    ports:
      - 11436:11436
    environment:
      - OLLAMA_HOST=0.0.0.0:11436
    volumes:
      - ~/.ollama:/root/.ollama

  opensearch:
    profiles: [all, h9y, opensearch]
    image: opensearchproject/opensearch:3.3.2
    environment:
      - cluster.name=opensearch-cluster
      - node.name=opensearch
      - discovery.seed_hosts=opensearch
      - cluster.initial_cluster_manager_nodes=opensearch
      - bootstrap.memory_lock=true
      - "OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m"
      - OPENSEARCH_INITIAL_ADMIN_PASSWORD=freeS0cketKeep-1iveTimeout
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - opensearch-volume:/usr/share/opensearch/data
    ports:
      - 9200:9200 # REST API
      - 9600:9600 # Performance Analyzer

  prometheus:
    profiles: [all, h9y, prometheus]
    image: prom/prometheus:v3.7.3
    ports:
      - "9090:9090"
    volumes:
      - ./config/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-volume:/prometheus
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.prometheus.rule=Host(`prometheus.${DOMAIN}`)"
      - "traefik.http.routers.prometheus.entrypoints=websecure"
      - "traefik.http.routers.prometheus.tls=true"
      - "traefik.http.services.prometheus.loadbalancer.server.port=9090"

  pushgateway:
    profiles: [all, h9y, pushgateway]
    image: prom/pushgateway:v1.11.2
    ports:
      - "9091:9091"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.pushgateway.rule=Host(`pushgateway.${DOMAIN}`)"
      - "traefik.http.routers.pushgateway.entrypoints=websecure"
      - "traefik.http.routers.pushgateway.tls=true"
      - "traefik.http.services.pushgateway.loadbalancer.server.port=9091"

  ### FRONTENT ###

  selfdev-app:
    profiles: [all, h9y, app, main]
    platform: ${PLATFORM}
    image: ${REGISTRY}selfdev-app:${VERSION}
    build:
      context: ./selfdev-app/
    command: sh -c "rm -rf node_modules/.vite && npm start"
    ports:
      - 3990:3990
    environment:
      - PORT=3990
      - ALLOWED_HOSTS=${DOMAIN}
      - VITE_WEB_URL=https://${DOMAIN}
      - VITE_API_URL=https://api.${DOMAIN}/v1
      - VITE_BRIDGE_URL=https://bridge.${DOMAIN}
      - VITE_DOCS_URL=https://docs.${DOMAIN}
      - VITE_XMPP_HOST=x.${DOMAIN}
      - VITE_XMPP_WEBSOCKET_URL=wss://x.${DOMAIN}/xmpp-websocket
      - VITE_XMPP_MUC_HOST=g.${DOMAIN}
      - VITE_XMPP_SHARE_HOST=f.${DOMAIN}
      - VITE_XMPP_SHARE_URL_PREFIX=https://api.${DOMAIN}/v1/files/
      - VITE_UMAMI_ENABLE=true
      - VITE_UMAMI_URL=https://umami.h9y.localhost/script.js
      - VITE_UMAMI_WEBSITE_ID=90f2b94f-3ee4-4988-b67c-e720100b65a3
      - VITE_SUBSCRIPTION_ENABLE=false
      - VITE_SUBSCRIBE_ENABLE=false
    # volumes:
    #   - ./selfdev-app/src:/opt/app/src
    #   - ./selfdev-app/public:/opt/app/public
    #   - ./selfdev-app/vite.config.js:/opt/app/vite.config.js
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.app.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.app.entrypoints=websecure"
      - "traefik.http.routers.app.tls=true"
      - "traefik.http.services.app.loadbalancer.server.port=3990"

  ### BACKEND ###

  selfdev-prosody:
    profiles: [all, h9y, agency, prosody]
    platform: ${PLATFORM}
    image: ${REGISTRY}selfdev-prosody:${VERSION}
    build:
      context: ./selfdev-prosody/
    restart: unless-stopped
    ports:
      - 5001:5000
      - 5222:5222
      - 5269:5269
      - 5280:5280
      - 5281:5281
      - 5347:5347
      - 8387:8387
    environment:
      - HOST=x.${DOMAIN}
      - MUC_HOST=g.${DOMAIN}
      - SHARE_HOST=f.${DOMAIN}
      - TURN_HOST=eturnal.${DOMAIN}
      - ADMINS=
      - S2S_INSECURE_DOMAINS=x.${REMOTE_DOMAIN}
      - S2S_SECURE_DOMAINS=
      - STORAGE=sql
      - SQL_DRIVER=PostgreSQL
      - SQL_DATABASE=postgres_prosody
      - SQL_USER=postgres_user
      - SQL_PASSWORD=postgres_secret_123
      - SQL_HOST=postgres
      # - HTTP_EXTERNAL_URL=https://x.${DOMAIN}/
      # - TRUSTED_PROXIES=127.0.0.1,::1,10.0.0.0/8,172.0.0.0/8
      - HTTP_FILE_SHARE_BASE_URL=https://api.${DOMAIN}/v1/files/
      - HTTP_FILE_SHARE_SECRET=U2VjcmV0VG9rZW4wMzYz
    volumes:
      # - ./selfdev-prosody/prosody.cfg.lua:/etc/prosody/prosody.cfg.lua
      # - ./selfdev-prosody/commander.sh:/commander.sh
      - ./certs/${DOMAIN}/tls.key:/etc/prosody/certs/${DOMAIN}.key
      - ./certs/${DOMAIN}/tls.crt:/etc/prosody/certs/${DOMAIN}.crt
    labels:
      - "traefik.enable=true"
      - "traefik.tcp.routers.prosody.rule=HostSNI(`x.${DOMAIN}`)"
      - "traefik.tcp.routers.prosody.entrypoints=websecure"
      - "traefik.tcp.routers.prosody.tls=true"
      - "traefik.tcp.routers.prosody.tls.passthrough=true"
      - "traefik.tcp.services.prosody.loadbalancer.server.port=5281"

  selfdev-api:
    profiles: [all, h9y, api, main]
    platform: ${PLATFORM}
    image: ${REGISTRY}selfdev-api:${VERSION}
    build:
      context: ./selfdev-api/
    ports:
      - 6369:6369
    depends_on:
      - mongo
      - vault
    env_file:
      - ./.env.api
    environment:
      - DB_URL=mongodb://mongo:27017/selfdev
      - WEB_APP_ORIGIN=https://${DOMAIN}
      - CORS_WHITELIST=https://${DOMAIN},https://app.${DOMAIN},http://m.${DOMAIN}
      - SESSION_DOMAIN=.${DOMAIN}
      - XMPP_HOST=x.${DOMAIN}
      - XMPP_WEBSOCKET_URL=wss://selfdev-prosody:5281/xmpp-websocket
      - XMPP_MUC_HOST=g.${DOMAIN}
      - XMPP_SHARE_HOST=f.${DOMAIN}
      - XMPP_SHARE_URL_PREFIX=https://api.${DOMAIN}/v1/files/
      - XMPP_COMMANDER_URL=http://selfdev-prosody:8387
      - XMPP_PASSWORD=a-geNt-$sec-ret-10m_pp
      - VAULT_ENABLE=true
      - VAULT_ADDR=http://vault:8200
      - VAULT_UNSEAL=true
      - VAULT_TOKEN
      - VAULT_UNSEAL_KEYS
      - LIMITS_ENABLE=false
      - STRIPE_ENABLE=true
      - YOOKASSA_ENABLE=true
      - OPENSEARCH_PASSWORD=freeS0cketKeep-1iveTimeout
      - OPENSEARCH_HOST=opensearch
      - PROMETHEUS_URL=http://prometheus:9090
      - PROMETHEUS_PUSHGATEWAY_URL=http://pushgateway:9091
      - FILES_SECURE=true
      - FILES_UPLOAD_SECRET=U2VjcmV0VG9rZW4wMzYz
      - FILES_STORAGE_DIR=/opt/data
    volumes:
      - selfdev-api-volume:/opt/data/
      # - ./selfdev-api/src:/opt/app/src
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api.rule=Host(`api.${DOMAIN}`)"
      - "traefik.http.routers.api.entrypoints=websecure"
      - "traefik.http.routers.api.tls=true"
      - "traefik.http.services.api.loadbalancer.server.port=6369"

  selfdev-swarm:
    profiles: [all, h9y, swarm]
    platform: ${PLATFORM}
    image: ${REGISTRY}selfdev-api:${VERSION}
    build:
      context: ./selfdev-api/
    command: npm run swarm
    links:
      - selfdev-bridge
    depends_on:
      - mongo
      - redis
    env_file:
      - ./.env.api
    environment:
      - CONTAINER_ID=selfdev-swarm
      - DB_URL=mongodb://mongo:27017/selfdev
      - REDIS_ENABLE=true
      - REDIS_URL=redis://redis:6379/1
      - XMPP_HOST=x.${DOMAIN}
      - XMPP_CONNECT_HOST=selfdev-prosody
      - XMPP_WEBSOCKET_URL=wss://selfdev-prosody:5281/xmpp-websocket
      - XMPP_MUC_HOST=g.${DOMAIN}
      - XMPP_SHARE_HOST=f.${DOMAIN}
      - XMPP_SHARE_URL_PREFIX=https://api.${DOMAIN}/v1/files/
      - XMPP_COMMANDER_URL=http://selfdev-prosody:8387
      - XMPP_PASSWORD=a-geNt-$sec-ret-10m_pp
      - VAULT_ENABLE=true
      - VAULT_ADDR=http://vault:8200
      - VAULT_UNSEAL=true
      - VAULT_TOKEN
      - VAULT_UNSEAL_KEYS
      - OPENSEARCH_PASSWORD=freeS0cketKeep-1iveTimeout
      - OPENSEARCH_HOST=opensearch
      - PROMETHEUS_PUSHGATEWAY_URL=http://pushgateway:9091
    # volumes:
    #   - ./selfdev-api/src:/opt/app/src

  selfdev-bridge:
    profiles: [all, h9y, bridge]
    platform: ${PLATFORM}
    image: ${REGISTRY}selfdev-bridge:${VERSION}
    build:
      context: ./selfdev-api/
      dockerfile: Dockerfile.bridge
    restart: unless-stopped
    depends_on:
      - mongo
      - redis
    ports:
      - 6370:6370
    env_file:
      - ./.env.api
    environment:
      - CONTAINER_ID=selfdev-bridge
      - DB_URL=mongodb://mongo:27017/selfdev
      - REDIS_ENABLE=true
      - REDIS_URL=redis://redis:6379/1
      - XMPP_HOST=x.${DOMAIN}
      - XMPP_CONNECT_HOST=selfdev-prosody
      - XMPP_WEBSOCKET_URL=wss://selfdev-prosody:5281/xmpp-websocket
      - XMPP_MUC_HOST=g.${DOMAIN}
      - XMPP_SHARE_HOST=f.${DOMAIN}
      - XMPP_SHARE_URL_PREFIX=https://api.${DOMAIN}/v1/files/
      - XMPP_COMMANDER_URL=http://selfdev-prosody:8387
      - XMPP_PASSWORD=a-geNt-$sec-ret-10m_pp
      - VAULT_ENABLE=true
      - VAULT_ADDR=http://vault:8200
      - VAULT_UNSEAL=true
      - VAULT_TOKEN
      - VAULT_UNSEAL_KEYS
      - FREESWITCH_HOST=192.168.50.100
      - FREESWITCH_PORT=8022
      - FREESWITCH_SSH_HOST=192.168.50.100
      - SPEACHES_BASE_URL=http://selfdev-speech:8372/v1
      - OPENSEARCH_PASSWORD=freeS0cketKeep-1iveTimeout
      - OPENSEARCH_HOST=opensearch
      - PROMETHEUS_PUSHGATEWAY_URL=http://pushgateway:9091
      - WEB_SERVER_PORT=6370
      - WEB_SERVER_ORIGIN=https://bridge.${DOMAIN}
    volumes:
      # - ./selfdev-api/src:/opt/app/src
      - selfdev-bridge-volume:/tmp/recordings
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.bridge.rule=Host(`bridge.${DOMAIN}`)"
      - "traefik.http.routers.bridge.entrypoints=websecure"
      - "traefik.http.routers.bridge.tls=true"
      - "traefik.http.services.bridge.loadbalancer.server.port=6370"

  selfdev-agency:
    profiles: [all, h9y, agency]
    platform: ${PLATFORM}
    image: ${REGISTRY}selfdev-agency:${VERSION}
    build:
      context: ./selfdev-agency/
    command: nodemon --exec python src/agency.py
    depends_on:
      - mongo
      - redis
    env_file:
      - ./.env.agency
    environment:
      - CONTAINER_ID=selfdev-agency
      - ALLOW_INSECURE=True
      - DB_URL=mongodb://mongo:27017/selfdev
      - XMPP_HOST=x.${DOMAIN}
      - XMPP_CONNECT_HOST=selfdev-prosody
      - XMPP_MUC_HOST=g.${DOMAIN}
      - XMPP_COMMANDER_URL=http://selfdev-prosody:8387
      - XMPP_PASSWORD=a-geNt-$sec-ret-10m_pp
      - REDIS_URL=redis://redis:6379/1
      - OLLAMA_BASE_URL=http://ollama:11436
      - LANGFLOW_URL=http://langflow:7860
      - NODERED_URL=http://nodered:1880
      - VAULT_ENABLE=true
      - VAULT_ADDR=http://vault:8200
      - VAULT_UNSEAL=true
      - VAULT_TOKEN
      - VAULT_UNSEAL_KEYS
      - CHROMA_HOST=chroma
      - CHROMA_PORT=8121
      - API_FILES_URL=http://selfdev-api:6369/v1/files/
      - XMPP_SHARE_URL_PREFIX=https://api.${DOMAIN}/v1/files/
      - XMPP_SHARE_HOST=f.${DOMAIN}
      - SSL_VERIFY=false
      - SPEACHES_BASE_URL=http://selfdev-speech:8372/v1
      - AVATAR_URL=http://selfdev-avatar:8533
      - OPENSEARCH_PASSWORD=freeS0cketKeep-1iveTimeout
      - OPENSEARCH_HOST=opensearch
      - PROMETHEUS_PUSHGATEWAY_URL=http://pushgateway:9091
    # volumes:
    #   - ./selfdev-agency/src/:/opt/app/src/
    stop_grace_period: 25s

  selfdev-fleet:
    profiles: [all, h9y, fleet]
    platform: ${PLATFORM}
    image: ${REGISTRY}selfdev-fleet:${VERSION}
    build:
      context: ./selfdev-agency/
      dockerfile: Dockerfile.fleet
    command: nodemon --exec python src/fleet.py
    depends_on:
      - mongo
      - redis
    env_file:
      - ./.env.agency
    environment:
      - CONTAINER_ID=selfdev-fleet
      - ALLOW_INSECURE=True
      - DB_URL=mongodb://mongo:27017/selfdev
      - XMPP_HOST=x.${DOMAIN}
      - XMPP_CONNECT_HOST=selfdev-prosody
      - XMPP_MUC_HOST=g.${DOMAIN}
      - XMPP_COMMANDER_URL=http://selfdev-prosody:8387
      - XMPP_PASSWORD=a-geNt-$sec-ret-10m_pp
      - REDIS_URL=redis://redis:6379/1
      - OLLAMA_BASE_URL=http://ollama:11436
      - VAULT_ENABLE=true
      - VAULT_ADDR=http://vault:8200
      - VAULT_UNSEAL=true
      - VAULT_TOKEN
      - VAULT_UNSEAL_KEYS
      - API_FILES_URL=http://selfdev-api:6369/v1/files/
      - XMPP_SHARE_URL_PREFIX=https://api.${DOMAIN}/v1/files/
      - XMPP_SHARE_HOST=f.${DOMAIN}
      - SSL_VERIFY=false
      - OPENSEARCH_PASSWORD=freeS0cketKeep-1iveTimeout
      - OPENSEARCH_HOST=opensearch
      - PROMETHEUS_PUSHGATEWAY_URL=http://pushgateway:9091
    # volumes:
    #   - ./selfdev-agency/src/:/opt/app/src/
    stop_grace_period: 25s

  selfdev-speech:
    profiles: [all, h9y, speech]
    platform: ${PLATFORM}
    image: ${REGISTRY}selfdev-speech:${VERSION}
    build:
      context: ./selfdev-speech/
    restart: unless-stopped
    ports:
      - 8372:8372
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://0.0.0.0:8372/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    volumes:
      - speech-volume:/home/ubuntu/.cache/huggingface/hub

  selfdev-avatar:
    profiles: [all, h9y, avatar]
    platform: ${PLATFORM}
    image: ${REGISTRY}selfdev-avatar:${VERSION}
    build:
      context: ./selfdev-avatar/
    restart: unless-stopped
    shm_size: '2gb'
    ports:
      - 8533:8533
    volumes:
      # - ./selfdev-avatar/src:/opt/app/src
      - selfdev-avatar-volume:/opt/app/data

  ### AUTOMATION ###

  langflow:
    profiles: [all, h9y, flow, langflow]
    image: langflowai/langflow:1.3.4
    ports:
      - 7860:7860
    depends_on:
      - langflowdb
    environment:
      - LANGFLOW_DATABASE_URL=postgresql://langflow:langflow@langflowdb:5432/langflow
      - LANGFLOW_CONFIG_DIR=app/langflow
      - DO_NOT_TRACK=true
    volumes:
      - langflow-volume:/app/langflow
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.langflow.rule=Host(`langflow.${DOMAIN}`)"
      - "traefik.http.routers.langflow.entrypoints=websecure"
      - "traefik.http.routers.langflow.tls=true"
      - "traefik.http.services.langflow.loadbalancer.server.port=7860"

  langflowdb:
    profiles: [all, h9y, langflow]
    image: postgres:16
    ports:
      - 5432:5432
    environment:
      POSTGRES_USER: langflow
      POSTGRES_PASSWORD: langflow
      POSTGRES_DB: langflow
    volumes:
      - langflowdb-volume:/var/lib/postgresql/data

  nodered:
    profiles: [all, h9y, nodered]
    image: nodered/node-red:4.0.9-22
    environment:
      - TZ=Europe/Amsterdam
    ports:
      - 1880:1880
    volumes:
      - nodered-volume:/data
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.nodered.rule=Host(`nodered.${DOMAIN}`)"
      - "traefik.http.routers.nodered.entrypoints=websecure"
      - "traefik.http.routers.nodered.tls=true"
      - "traefik.http.services.nodered.loadbalancer.server.port=1880"

volumes:
  mongo-volume:
  redis-volume:
  chroma-volume:
  postgres-volume:
  selfdev-api-volume:
  selfdev-bridge-volume:
  selfdev-avatar-volume:
  langflow-volume:
  langflowdb-volume:
  nodered-volume:
  vault-volume:
  speech-volume:
  opensearch-volume:
  prometheus-volume:

